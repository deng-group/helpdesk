name: Sub-Issue Handler

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  handle-sub-issue:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'sub-issue')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extend parent issue deadline
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const subIssueNumber = context.issue.number;
            const subIssueBody = context.payload.issue.body || '';

            // Read officer config
            let officerUsername = 'Tim-Pook';
            try {
              const officerConfig = fs.readFileSync('.github/officer-config.yml', 'utf8');
              const usernameMatch = officerConfig.match(/github_username:\s*["']([^"']+)["']/);
              if (usernameMatch) {
                officerUsername = usernameMatch[1];
              }
            } catch (error) {
              console.log('Officer config not found, using default');
            }

            // Try to find parent issue reference
            const parentMatch = subIssueBody.match(/Parent:?\s*#(\d+)/i);

            if (!parentMatch) {
              console.log('No parent issue found in sub-issue description');

              // Add a comment to the sub-issue reminding to add parent reference
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: subIssueNumber,
                body: `âš ï¸ **Sub-Issue Missing Parent Reference**\n\nThis issue is labeled as a sub-issue but doesn't reference a parent issue.\n\nPlease add a line like this to the description:\n\`\`\`\nParent: #123\n\`\`\`\n\n@${officerUsername} - This will allow automatic deadline extension for the parent issue.`
              });

              return;
            }

            const parentNumber = parseInt(parentMatch[1]);
            console.log(`Found parent issue: #${parentNumber}`);

            // Get parent issue
            let parentIssue;
            try {
              parentIssue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parentNumber
              });
            } catch (error) {
              console.log(`Parent issue #${parentNumber} not found or inaccessible`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: subIssueNumber,
                body: `âš ï¸ **Parent Issue Not Found**\n\nCouldn't find issue #${parentNumber}. Please verify the parent issue number.\n\n@${officerUsername}`
              });

              return;
            }

            const parentLabels = parentIssue.data.labels.map(l => l.name);

            // Check if parent already has an override label
            const overrideLabels = ['sla-exception', 'complex-issue', 'waiting-external', 'acknowledged-delay'];
            const hasOverride = overrideLabels.some(label => parentLabels.includes(label));

            if (hasOverride) {
              console.log(`Parent issue #${parentNumber} already has override label - no action needed`);
            } else {
              // Add acknowledged-delay label to parent
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parentNumber,
                labels: ['acknowledged-delay']
              });

              console.log(`Added 'acknowledged-delay' label to parent issue #${parentNumber}`);
            }

            // Add comment to parent issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentNumber,
              body: `ðŸ”— **Sub-Issue Created**\n\nA sub-issue has been created: #${subIssueNumber}\n\nThe deadline for this parent issue has been automatically extended to accommodate the sub-issue work. The SLA tracking will be paused until the sub-issue is resolved.\n\n*Sub-issues allow breaking down complex problems into smaller, manageable tasks with flexible timelines.*`
            });

            // Add comment to sub-issue confirming linkage
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: subIssueNumber,
              body: `âœ… **Linked to Parent Issue**\n\nThis sub-issue is now linked to parent issue #${parentNumber}.\n\n- This sub-issue is exempt from normal SLA tracking\n- The parent issue deadline has been automatically extended\n- When this sub-issue is closed, remember to update the parent issue\n\n@${officerUsername}`
            });

            console.log('Sub-issue handling complete!');
