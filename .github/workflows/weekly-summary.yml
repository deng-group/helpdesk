name: Weekly Summary Report

on:
  schedule:
    # Run every Monday at 9 AM SGT (1 AM UTC)
    - cron: '0 1 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  issues: write
  contents: read

jobs:
  generate-report:
    runs-on: ubuntu-latest
    name: Generate weekly ticket summary

    steps:
      - name: Generate and post report
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const oneWeekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

            // Format dates
            const formatDate = (date) => date.toISOString().split('T')[0];
            const weekStart = formatDate(oneWeekAgo);
            const weekEnd = formatDate(now);

            console.log(`Generating report for ${weekStart} to ${weekEnd}`);

            // Get all issues (open and closed)
            const allIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100,
              since: oneWeekAgo.toISOString()
            });

            // Filter out pull requests
            const issues = allIssues.data.filter(i => !i.pull_request);

            // Calculate metrics
            const createdThisWeek = issues.filter(i => new Date(i.created_at) >= oneWeekAgo);
            const closedThisWeek = issues.filter(i => i.state === 'closed' && new Date(i.closed_at) >= oneWeekAgo);

            // Get all currently open issues
            const openIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const currentlyOpen = openIssues.data.filter(i => !i.pull_request);

            // Count by priority
            const countByLabel = (issues, labelPrefix) => {
              const counts = {};
              issues.forEach(issue => {
                const label = issue.labels.find(l => l.name.startsWith(labelPrefix));
                if (label) {
                  counts[label.name] = (counts[label.name] || 0) + 1;
                }
              });
              return counts;
            };

            const openByPriority = countByLabel(currentlyOpen, 'priority:');
            const openByCategory = countByLabel(currentlyOpen, 'category:');

            // Count overdue tickets
            const overdueTickets = currentlyOpen.filter(i => i.labels.some(l => l.name === 'overdue'));

            // Calculate response times for closed tickets
            let totalResponseTime = 0;
            let ticketsWithResponse = 0;

            for (const issue of closedThisWeek) {
              // Get first comment by timpook or anyone other than issue creator
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 100
              });

              const firstResponse = comments.data.find(c => c.user.login !== issue.user.login);
              if (firstResponse) {
                const responseTime = new Date(firstResponse.created_at) - new Date(issue.created_at);
                totalResponseTime += responseTime;
                ticketsWithResponse++;
              }
            }

            const avgResponseHours = ticketsWithResponse > 0
              ? (totalResponseTime / ticketsWithResponse / (1000 * 60 * 60)).toFixed(1)
              : 'N/A';

            // Calculate oldest ticket age
            let oldestTicketAge = 0;
            let oldestTicketNumber = null;
            currentlyOpen.forEach(issue => {
              const age = (now - new Date(issue.created_at)) / (1000 * 60 * 60 * 24);
              if (age > oldestTicketAge) {
                oldestTicketAge = age;
                oldestTicketNumber = issue.number;
              }
            });

            // Generate report
            let report = `# ğŸ“Š Weekly Help Desk Report

**Period:** ${weekStart} to ${weekEnd}

---

## ğŸ“ˆ Overview

| Metric | Count |
|--------|-------|
| ğŸ†• New Tickets | ${createdThisWeek.length} |
| âœ… Closed Tickets | closedThisWeek.length} |
| ğŸ“‚ Currently Open | ${currentlyOpen.length} |
| âš ï¸ Overdue | ${overdueTickets.length} |

**Net Change:** ${createdThisWeek.length - closedThisWeek.length > 0 ? '+' : ''}${createdThisWeek.length - closedThisWeek.length}

---

## â±ï¸ Response Time

- **Average Response Time:** ${avgResponseHours} hours
- **Target:** <24 hours for medium priority

${ticketsWithResponse > 0 ? `*Based on ${ticketsWithResponse} resolved tickets this week*` : '*No tickets resolved this week*'}

---

## ğŸ“Š Open Tickets Breakdown

### By Priority
${Object.keys(openByPriority).length > 0 ? Object.entries(openByPriority).map(([label, count]) => `- ${label}: ${count}`).join('\n') : '- None'}

### By Category
${Object.keys(openByCategory).length > 0 ? Object.entries(openByCategory).map(([label, count]) => `- ${label}: ${count}`).join('\n') : '- None'}

---

## âš ï¸ Attention Needed

${overdueTickets.length > 0 ? `
### Overdue Tickets (${overdueTickets.length})
${overdueTickets.map(i => `- #${i.number}: ${i.title}`).join('\n')}
` : 'âœ… No overdue tickets!'}

${oldestTicketNumber ? `
### Oldest Open Ticket
- #${oldestTicketNumber} (${Math.floor(oldestTicketAge)} days old)
` : ''}

---

## ğŸ“‹ Tickets Opened This Week

${createdThisWeek.length > 0 ? createdThisWeek.map(i => {
  const priority = i.labels.find(l => l.name.startsWith('priority:'))?.name || 'no priority';
  const category = i.labels.find(l => l.name.startsWith('category:'))?.name || 'uncategorized';
  return `- #${i.number}: ${i.title} [${priority}, ${category}]`;
}).join('\n') : '*No new tickets this week*'}

---

## âœ… Tickets Closed This Week

${closedThisWeek.length > 0 ? closedThisWeek.map(i => `- #${i.number}: ${i.title}`).join('\n') : '*No tickets closed this week*'}

---

## ğŸ’¡ Insights

${createdThisWeek.length === 0 && closedThisWeek.length === 0 ? '- Quiet week! No new tickets.' : ''}
${overdueTickets.length > 3 ? `- âš ï¸ High number of overdue tickets (${overdueTickets.length}). Consider reviewing workload or priorities.` : ''}
${createdThisWeek.length > closedThisWeek.length + 5 ? '- âš ï¸ Tickets are accumulating. New tickets outpacing closures.' : ''}
${currentlyOpen.length === 0 ? '- ğŸ‰ All tickets resolved! Great work!' : ''}
${avgResponseHours !== 'N/A' && parseFloat(avgResponseHours) < 12 ? '- âœ¨ Excellent response time this week!' : ''}

---

*This report is generated automatically every Monday. View [all open tickets](../../../issues) or [create a new ticket](../../../issues/new/choose).*
`;

            // Create issue with report
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Weekly Report: ${weekStart} to ${weekEnd}`,
              body: report,
              labels: ['report']
            });

            console.log('Weekly report created successfully!');
