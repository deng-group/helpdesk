name: Welcome Bot

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  welcome:
    runs-on: ubuntu-latest
    name: Welcome new ticket submitter

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add welcome comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            // Read officer config
            let officerName = 'Tim Pook'; // fallback
            let officerEmail = 'tim.pook@nus.edu.sg'; // fallback
            try {
              const officerConfig = fs.readFileSync('.github/officer-config.yml', 'utf8');
              const nameMatch = officerConfig.match(/name:\s*["']([^"']+)["']/);
              const emailMatch = officerConfig.match(/email:\s*["']([^"']+)["']/);
              if (nameMatch) officerName = nameMatch[1];
              if (emailMatch) officerEmail = emailMatch[1];
            } catch (error) {
              console.log('Officer config not found, using defaults');
            }

            // Check if officer is on leave by reading YAML file as text
            let onLeave = false;
            let leaveInfo = {
              leave_end: 'TBD',
              leave_reason: '',
              urgent_instructions: 'Please contact Prof. Zeyu Deng or wait until Tim returns.'
            };

            try {
              const yamlContent = fs.readFileSync('.github/on-leave.yml', 'utf8');
              // Simple parsing - look for "on_leave: true"
              onLeave = yamlContent.includes('on_leave: true');

              // Extract leave_end date
              const leaveEndMatch = yamlContent.match(/leave_end:\s*["']([^"']+)["']/);
              if (leaveEndMatch) leaveInfo.leave_end = leaveEndMatch[1];

              // Extract leave_reason
              const leaveReasonMatch = yamlContent.match(/leave_reason:\s*["']([^"']+)["']/);
              if (leaveReasonMatch) leaveInfo.leave_reason = leaveReasonMatch[1];

              // Extract urgent_instructions
              const urgentMatch = yamlContent.match(/urgent_instructions:\s*["']([^"']+)["']/);
              if (urgentMatch) leaveInfo.urgent_instructions = urgentMatch[1];

            } catch (error) {
              console.log('Leave config not found, assuming officer is available');
            }

            // Determine priority and expected timeframes
            let priority = 'medium';
            let responseTime = '24 hours';
            let resolutionTime = '5 days';

            if (labels.includes('priority: urgent')) {
              priority = 'urgent';
              responseTime = '2 hours';
              resolutionTime = '8 hours';
            } else if (labels.includes('priority: high')) {
              priority = 'high';
              responseTime = '4 hours';
              resolutionTime = '3 days';
            } else if (labels.includes('priority: low')) {
              priority = 'low';
              responseTime = '48 hours';
              resolutionTime = '7 days';
            }

            // Create welcome message (different if on leave)
            let welcomeMessage;

            if (onLeave) {
              const returnDate = leaveInfo.leave_end || 'TBD';
              const urgentInstructions = leaveInfo.urgent_instructions || 'Please contact Prof. Zeyu Deng or wait until Tim returns.';

              welcomeMessage = 'üëã Hi @' + issue.user.login + '!\n\n';
              welcomeMessage += 'Thank you for submitting this ticket.\n\n';
              welcomeMessage += 'üìÖ **Important Notice:** ' + officerName + ' is currently on leave and will return on **' + returnDate + '**.\n\n';
              if (leaveInfo.leave_reason) {
                welcomeMessage += '**Reason:** ' + leaveInfo.leave_reason + '\n\n';
              }
              welcomeMessage += '**What this means for your ticket:**\n';
              welcomeMessage += '- ' + (priority === 'urgent' ? 'üî¥ **Urgent ticket:**' : 'üìã **Your ticket:**') + ' Will be addressed when Tim returns\n';
              welcomeMessage += '- **For urgent issues:** ' + urgentInstructions + '\n';
              welcomeMessage += '- **For non-urgent issues:** Please wait, and Tim will respond when he\'s back\n\n';
              welcomeMessage += '---\n\n';
              welcomeMessage += '**In the meantime:**\n';
              welcomeMessage += '- üìñ Check our [FAQ](../blob/main/docs/faq.md) for common solutions\n';
              welcomeMessage += '- üìö Review our [intranet guides](https://intranet.matsci.dev/Orientation/get-started)\n';
              welcomeMessage += '- üîî You\'ll receive email notifications when Tim responds\n\n';
              welcomeMessage += 'If you need to add more information, just comment below!\n\n';
              welcomeMessage += 'Thank you for your patience! üôè\n\n';
              welcomeMessage += '---\n\n';
              welcomeMessage += '*This is an automated message.*';

            } else {
              // Normal welcome message (officer available)
              welcomeMessage = 'üëã Hi @' + issue.user.login + '!\n\n';
              welcomeMessage += 'Thank you for submitting this ticket. I\'ve received it and will get back to you soon.\n\n';
              welcomeMessage += 'üìã **Ticket Details:**\n';
              welcomeMessage += '- **Priority:** ' + priority + '\n';
              welcomeMessage += '- **Expected first response:** Within ' + responseTime + '\n';
              welcomeMessage += '- **Expected resolution:** Within ' + resolutionTime + '\n\n';
              welcomeMessage += '*These are target timeframes during business hours (Mon-Fri, 9 AM - 5 PM SGT). Complex issues may take longer.*\n\n';
              welcomeMessage += '---\n\n';
              welcomeMessage += '**In the meantime:**\n';
              welcomeMessage += '- üìñ Check our [FAQ](../blob/main/docs/faq.md) for common solutions\n';
              welcomeMessage += '- üìö Review our [intranet guides](https://intranet.matsci.dev/Orientation/get-started)\n';
              welcomeMessage += '- üîî You\'ll receive email notifications when there are updates\n\n';
              welcomeMessage += 'If you need to add more information, just comment below!\n\n';
              welcomeMessage += '**For urgent issues:** If this becomes urgent and you don\'t get a response within ' + responseTime + ', email ' + officerName.split(' ')[0] + ' directly at ' + officerEmail + ' with "URGENT" in the subject line.\n\n';
              welcomeMessage += '---\n\n';
              welcomeMessage += '*This is an automated message. ' + officerName.split(' ')[0] + ' will respond personally soon!*';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: welcomeMessage
            });

            console.log(`Welcome comment added to issue #${issue.number} (on leave: ${onLeave})`);
