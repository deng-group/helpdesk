name: Welcome Bot

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  welcome:
    runs-on: ubuntu-latest
    name: Welcome new ticket submitter

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add welcome comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            const fallbackSla = {
              priorities: {
                'priority: urgent': { response_hours: 4, resolution_hours: 8, emoji: 'ğŸ”´', name: 'urgent' },
                'priority: high': { response_hours: 4, resolution_hours: 72, emoji: 'ğŸŸ ', name: 'high' },
                'priority: medium': { response_hours: 24, resolution_hours: 120, emoji: 'ğŸŸ¡', name: 'medium' },
                'priority: low': { response_hours: 48, resolution_hours: 168, emoji: 'ğŸŸ¢', name: 'low' }
              },
              default_priority: 'priority: medium',
              procurement: {
                label: 'category: procurement',
                response_hours: 48,
                resolution_hours: 1008
              }
            };

            const loadSlaConfig = () => {
              try {
                const raw = fs.readFileSync('config/sla.json', 'utf8');
                return JSON.parse(raw);
              } catch (error) {
                console.log('SLA config not found or invalid - using defaults');
                return {};
              }
            };

            const rawSlaConfig = loadSlaConfig();
            const priorityConfig = { ...fallbackSla.priorities, ...(rawSlaConfig.priorities || {}) };
            const defaultPriority = rawSlaConfig.default_priority || fallbackSla.default_priority;
            const procurementConfig = { ...fallbackSla.procurement, ...(rawSlaConfig.procurement || {}) };

            const determinePriorityLabel = (ticketLabels) => {
              for (const labelName of Object.keys(priorityConfig)) {
                if (ticketLabels.includes(labelName)) {
                  return labelName;
                }
              }
              return defaultPriority;
            };

            const getPriorityEntry = (priorityLabel) => {
              return priorityConfig[priorityLabel] || priorityConfig[defaultPriority] || Object.values(priorityConfig)[0];
            };

            const getFriendlyPriority = (priorityLabel) => {
              const entry = priorityConfig[priorityLabel];
              if (entry && entry.name && entry.emoji) {
                return { name: entry.name, emoji: entry.emoji };
              }

              const name = priorityLabel.replace('priority:', '').trim() || priorityLabel;
              const emoji = {
                urgent: 'ğŸ”´',
                high: 'ğŸŸ ',
                medium: 'ğŸŸ¡',
                low: 'ğŸŸ¢'
              }[name] || 'ğŸŸ¡';

              return { name, emoji };
            };

            const formatDuration = (hours) => {
              if (typeof hours !== 'number') return 'N/A';
              if (hours >= 24 && hours % 24 === 0) {
                const days = hours / 24;
                return `${hours} hours (${days} day${days === 1 ? '' : 's'})`;
              }
              return `${hours} hours`;
            };

            // Read officer config
            let officerName = 'Tim Pook'; // fallback
            let officerEmail = 'tim.pook@nus.edu.sg'; // fallback
            try {
              const officerConfig = fs.readFileSync('.github/officer-config.yml', 'utf8');
              const nameMatch = officerConfig.match(/name:\s*["']([^"']+)["']/);
              const emailMatch = officerConfig.match(/email:\s*["']([^"']+)["']/);
              if (nameMatch) officerName = nameMatch[1];
              if (emailMatch) officerEmail = emailMatch[1];
            } catch (error) {
              console.log('Officer config not found, using defaults');
            }

            // Check if officer is on leave by reading YAML file as text
            let onLeave = false;
            let leaveInfo = {
              leave_end: 'TBD',
              leave_reason: '',
              urgent_instructions: 'Please contact Prof. Zeyu Deng or wait until Tim returns.'
            };

            try {
              const yamlContent = fs.readFileSync('.github/on-leave.yml', 'utf8');
              // Simple parsing - look for "on_leave: true"
              onLeave = yamlContent.includes('on_leave: true');

              // Extract leave_end date
              const leaveEndMatch = yamlContent.match(/leave_end:\s*["']([^"']+)["']/);
              if (leaveEndMatch) leaveInfo.leave_end = leaveEndMatch[1];

              // Extract leave_reason
              const leaveReasonMatch = yamlContent.match(/leave_reason:\s*["']([^"']+)["']/);
              if (leaveReasonMatch) leaveInfo.leave_reason = leaveReasonMatch[1];

              // Extract urgent_instructions
              const urgentMatch = yamlContent.match(/urgent_instructions:\s*["']([^"']+)["']/);
              if (urgentMatch) leaveInfo.urgent_instructions = urgentMatch[1];

            } catch (error) {
              console.log('Leave config not found, assuming officer is available');
            }

            // Determine priority and expected timeframes
            const priorityLabel = determinePriorityLabel(labels);
            const priorityEntry = getPriorityEntry(priorityLabel);
            const priorityMeta = getFriendlyPriority(priorityLabel);
            const isProcurement = procurementConfig.label && labels.includes(procurementConfig.label);

            const responseHours = isProcurement
              ? procurementConfig.response_hours
              : priorityEntry?.response_hours;
            const resolutionHours = isProcurement
              ? procurementConfig.resolution_hours
              : priorityEntry?.resolution_hours;

            const responseTime = formatDuration(responseHours);
            const resolutionTime = formatDuration(resolutionHours);

            // Create welcome message (different if on leave)
            let welcomeMessage;

            const isUrgent = priorityLabel === 'priority: urgent';
            const isHigh = priorityLabel === 'priority: high';
            const prettyPriorityName = (priorityMeta.name && priorityMeta.name.length > 0)
              ? priorityMeta.name.charAt(0).toUpperCase() + priorityMeta.name.slice(1)
              : priorityLabel;

            if (onLeave) {
              const returnDate = leaveInfo.leave_end || 'TBD';
              const urgentInstructions = leaveInfo.urgent_instructions || 'Please contact Prof. Zeyu Deng or wait until Tim returns.';

              welcomeMessage = 'ğŸ‘‹ Hi @' + issue.user.login + '!\n\n';
              welcomeMessage += 'Thanks for your ticket! **' + officerName + ' is currently on leave** and will return on **' + returnDate + '**.\n\n';
              if (isUrgent) {
                welcomeMessage += 'ğŸ”´ **For urgent issues:** ' + urgentInstructions + '\n\n';
              } else {
                welcomeMessage += 'Your ticket will be handled when ' + officerName.split(' ')[0] + ' returns. You\'ll get email updates.\n\n';
              }
              welcomeMessage += 'ğŸ“– Check the [FAQ](../blob/main/docs/faq.md) while you wait!\n\n';
              welcomeMessage += '---\n';
              welcomeMessage += '*ğŸ¤– Automated message*';

            } else {
              // Normal welcome message (officer available)
              welcomeMessage = 'ğŸ‘‹ Hi @' + issue.user.login + '!\n\n';
              welcomeMessage += 'Thanks for your ticket! ' + officerName.split(' ')[0] + ' has been notified.\n\n';
              welcomeMessage += (priorityMeta.emoji || 'ğŸŸ¡') + ' **Priority:** ' + prettyPriorityName + ' â€¢ **Expected response:** ' + responseTime + '\n\n';
              welcomeMessage += 'ğŸ› ï¸ **Expected resolution:** ' + resolutionTime + '\n\n';
              welcomeMessage += 'ğŸ“– Check the [FAQ](../blob/main/docs/faq.md) for quick solutions.\n\n';
              if (isProcurement) {
                welcomeMessage += 'ğŸ›’ Procurement requests follow longer timelines (ordering, delivery, setup).\n\n';
              } else if (isUrgent || isHigh) {
                welcomeMessage += '**Urgent?** Email ' + officerEmail + ' if no response within ' + responseTime + '.\n\n';
              }
              welcomeMessage += '---\n';
              welcomeMessage += '*ğŸ¤– Automated message â€¢ ' + officerName.split(' ')[0] + ' will respond soon!*';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: welcomeMessage
            });

            console.log(`Welcome comment added to issue #${issue.number} (on leave: ${onLeave})`);
